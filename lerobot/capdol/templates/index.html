<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¡œë´‡ í•¸ë“œ ì»¨íŠ¸ë¡¤ëŸ¬</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #181818; color: #eee; padding: 20px; }
    
    /* Layout */
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { color: #ffa500; margin-bottom: 10px; }
    .header .subtitle { color: #ccc; font-size: 1.1em; }
    
    .container { max-width: 1400px; margin: 0 auto; }
    .grid { display: grid; gap: 20px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    
    /* Components */
    .card { background: #222; border-radius: 16px; padding: 20px; border: 2px solid #444; }
    .card-title { color: #ffa500; margin-bottom: 15px; font-size: 1.4em; }
    .card-subtitle { color: #ccc; margin-bottom: 15px; font-size: 0.95em; }
    
    .btn { padding: 10px 20px; font-size: 1em; margin: 5px; background: #ffa500; 
           border: none; border-radius: 8px; color: #222; font-weight: bold; 
           cursor: pointer; transition: all 0.3s; min-width: 100px; }
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { background: #666; color: #999; cursor: not-allowed; transform: none; }
    
    /* Button variants */
    .btn-green { background: #4caf50; } .btn-green:hover { background: #81c784; }
    .btn-red { background: #f44336; } .btn-red:hover { background: #e57373; }
    .btn-blue { background: #2196f3; } .btn-blue:hover { background: #64b5f6; }
    .btn-purple { background: #9c27b0; } .btn-purple:hover { background: #ba68c8; }
    .btn-orange { background: #ff9800; } .btn-orange:hover { background: #ffb74d; }
    
    /* Camera */
    .camera-grid { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin: 20px 0; }
    .camera-box { border: 2px solid #ffa500; border-radius: 16px; padding: 8px; background: #222; }
    .camera-title { margin-bottom: 8px; color: #ffa500; font-weight: bold; text-align: center; }
    .camera-box img { max-width: 100%; height: auto; }
    
    /* Status */
    .status-bar { position: fixed; top: 10px; right: 10px; padding: 8px 15px; 
                  border-radius: 5px; font-size: 0.9em; z-index: 1000; }
    .status-connected { background: #4caf50; }
    .status-disconnected { background: #f44336; }
    
    .status-grid { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
    .status-item { background: #333; padding: 12px 16px; border-radius: 8px; 
                   border: 1px solid #444; min-width: 160px; text-align: center; }
    
    .indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; 
                 margin-right: 6px; background: #666; }
    .indicator.on { background: #4caf50; }
    .indicator.off { background: #f44336; }
    .indicator.warning { background: #ff9800; }
    .indicator.pulse { animation: pulse 2s infinite; }
    
    @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    
    /* Data table */
    .data-table { width: 100%; border-collapse: collapse; background: #222; 
                  border-radius: 10px; overflow: hidden; margin: 20px 0; }
    .data-table th, .data-table td { padding: 8px 12px; border: 1px solid #444; text-align: center; }
    .data-table th { background: #333; color: #ffa500; }
    .data-table td { background: #262626; }
    
    /* Voice log */
    .voice-log { height: 200px; overflow-y: auto; padding: 12px; background: #262626; 
                 border-radius: 8px; font-family: monospace; font-size: 0.9em; 
                 border: 1px solid #444; }
    .voice-entry { margin: 6px 0; padding: 4px; border-radius: 4px; }
    .voice-listening { color: #64b5f6; }
    .voice-wake-word { color: #4caf50; font-weight: bold; }
    .voice-command { color: #ba68c8; font-weight: bold; }
    .voice-executed { color: #ffa500; font-weight: bold; }
    .voice-timeout { color: #ff9800; }
    .voice-error { color: #f44336; font-weight: bold; }
    
    /* Notification */
    .notification { position: fixed; top: 60px; right: 10px; padding: 10px 15px; 
                    border-radius: 5px; color: white; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
    .notification.show { opacity: 1; }
    .notification.success { background: #4caf50; }
    .notification.error { background: #f44336; }
    .notification.warning { background: #ff9800; }
    
    /* CSV Info */
    .csv-info { background: #333; border-radius: 8px; padding: 15px; margin-top: 15px; 
                font-family: monospace; display: none; }
    .csv-info div { margin: 6px 0; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .camera-grid { flex-direction: column; align-items: center; }
      .status-grid { flex-direction: column; align-items: center; }
      .grid { grid-template-columns: 1fr; }
      .btn { width: 100%; margin: 5px 0; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div id="status-bar" class="status-bar status-disconnected">ì—°ê²° ì¤‘...</div>
  <div id="notification" class="notification"></div>
  
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– ë¡œë´‡ í•¸ë“œ ì»¨íŠ¸ë¡¤ëŸ¬</h1>
      <div class="subtitle">AI ê¸°ë°˜ ë¡œë´‡ ì œì–´ ì‹œìŠ¤í…œ</div>
    </div>

    <!-- Camera Section -->
    <div class="camera-grid">
      <div class="camera-box">
        <div class="camera-title">ğŸ“¹ Camera 1 (Control)</div>
        <img src="/video_feed1" width="640" height="480" alt="Camera 1" />
      </div>
      <div class="camera-box">
        <div class="camera-title">ğŸ“¹ Camera 2 (Depth)</div>
        <img src="/video_feed2" width="640" height="480" alt="Camera 2" />
      </div>
    </div>

    <!-- Main Controls -->
    <div class="grid grid-2">
      <!-- Data Collection -->
      <div class="card">
        <h3 class="card-title">ğŸ“Š ë°ì´í„° ìˆ˜ì§‘</h3>
        <div class="card-subtitle">í˜„ì¬ ë¡œë´‡ ìƒíƒœë¥¼ CSV íŒŒì¼ì— ì €ì¥</div>
        <div class="grid grid-4">
          <button class="btn btn-green" onclick="takeSnapshot()">ğŸ“¸ ì €ì¥</button>
          <button class="btn btn-blue" onclick="getCsvInfo()">ğŸ“‹ ì •ë³´</button>
          <button class="btn btn-red" onclick="clearCsv()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        <div id="csv-info" class="csv-info">
          <div><strong>íŒŒì¼:</strong> <span id="csv-path">-</span></div>
          <div><strong>ë°ì´í„°:</strong> <span id="csv-rows">0</span>í–‰</div>
          <div><strong>í¬ê¸°:</strong> <span id="csv-size">0</span> bytes</div>
        </div>
      </div>

      <!-- Hand Control -->
      <div class="card">
        <h3 class="card-title">ğŸ¯ ì† ì¶”ì  ì œì–´</h3>
        <div class="card-subtitle">ì† ì›€ì§ì„ìœ¼ë¡œ ë¡œë´‡ ì œì–´</div>
        <button id="control-btn" class="btn btn-green" onclick="toggleControl()">ì œì–´ ì‹œì‘</button>
      </div>

      <!-- Voice Control -->
      <div class="card">
        <h3 class="card-title">ğŸ¤ ìŒì„± ì œì–´</h3>
        <div class="card-subtitle">ìŒì„± ëª…ë ¹ìœ¼ë¡œ ë¡œë´‡ ì œì–´</div>
        <button id="voice-btn" class="btn btn-blue" onclick="toggleVoice()">ìŒì„± ì‹œì‘</button>
        <div id="voice-log" class="voice-log">
          <div class="voice-entry">ìŒì„± ì¸ì‹ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
        <div style="margin-top: 10px; font-size: 0.9em;">
          <div><strong>ì›¨ì´í¬ì›Œë“œ:</strong> í•˜ì´ë´‡, ì•„ì´ë´‡</div>
          <div><strong>ëª…ë ¹ì–´:</strong> ì™¼ìª½, ì˜¤ë¥¸ìª½, ìœ„, ì•„ë˜, ì¢…ë£Œ</div>
        </div>
      </div>

      <!-- Manual Control -->
      <div class="card">
        <h3 class="card-title">ğŸ•¹ï¸ ìˆ˜ë™ ì œì–´</h3>
        <div class="card-subtitle">ë¡œë´‡ ëª¨ë“œ ë° LED ì œì–´</div>
        <div class="grid grid-4">
          <button class="btn btn-blue" onclick="setMode(0)">ëª¨ë“œ 0</button>
          <button class="btn btn-purple" onclick="setMode(1)">ëª¨ë“œ 1</button>
        </div>
        <div class="grid grid-4" style="margin-top: 15px;">
          <button class="btn btn-orange" onclick="setLED(0)">LED OFF</button>
          <button class="btn btn-orange" onclick="setLED(1)">LED 1</button>
          <button class="btn btn-orange" onclick="setLED(3)">LED 3</button>
          <button class="btn btn-orange" onclick="setLED(5)">LED MAX</button>
        </div>
      </div>
    </div>

    <!-- Status Panel -->
    <div class="status-grid">
      <div class="status-item">
        <span id="control-status"><span class="indicator off"></span>ì œì–´: ë¹„í™œì„±</span>
      </div>
      <div class="status-item">
        <span id="mode-status"><span class="indicator off"></span>ëª¨ë“œ: -</span>
      </div>
      <div class="status-item">
        <span id="led-status"><span class="indicator off"></span>LED: -</span>
      </div>
      <div class="status-item">
        <span id="voice-status"><span class="indicator off"></span>ìŒì„±: ë¹„í™œì„±</span>
      </div>
    </div>

    <!-- Data Table -->
    <table class="data-table">
      <tr>
        <th>Cam1 X</th><th>Cam1 Y</th><th>Cam2 X</th><th>Cam2 Y</th>
        <th>Joint 1</th><th>Joint 2</th><th>Joint 3</th><th>Joint 4</th>
      </tr>
      <tr id="data-row">
        <td colspan="8">ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</td>
      </tr>
    </table>
  </div>

  <script>
    // Global state
    let socket, isConnected = false, controlActive = false, voiceActive = false;
    
    // Utility functions
    const $ = id => document.getElementById(id);
    const updateIndicator = (id, status) => {
      const el = $(id).querySelector('.indicator');
      el.className = `indicator ${status}`;
    };
    
    const showNotification = (msg, type = 'success') => {
      const n = $('notification');
      n.textContent = msg;
      n.className = `notification ${type} show`;
      setTimeout(() => n.classList.remove('show'), 3000);
    };
    
    const updateConnection = connected => {
      isConnected = connected;
      const bar = $('status-bar');
      bar.textContent = connected ? 'ğŸŸ¢ ì—°ê²°ë¨' : 'ğŸ”´ ì—°ê²° ëŠê¹€';
      bar.className = `status-bar status-${connected ? 'connected' : 'disconnected'}`;
      
      // Enable/disable all buttons
      document.querySelectorAll('.btn').forEach(btn => btn.disabled = !connected);
    };
    
    const emit = (event, data, callback) => {
      if (!isConnected) {
        showNotification('ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      socket.emit(event, data, callback);
    };
    
    // Control functions
    const toggleControl = () => {
      emit(controlActive ? 'stop_control' : 'start_control', {}, res => {
        if (res.success) {
          showNotification(`ì œì–´ê°€ ${controlActive ? 'ì¤‘ì§€' : 'ì‹œì‘'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          showNotification('ì œì–´ ë³€ê²½ ì‹¤íŒ¨', 'error');
        }
      });
    };
    
    const toggleVoice = () => {
      emit(voiceActive ? 'stop_voice_recognition' : 'start_voice_recognition', {}, res => {
        if (res.success) {
          showNotification(`ìŒì„± ì¸ì‹ì´ ${voiceActive ? 'ì¤‘ì§€' : 'ì‹œì‘'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          showNotification('ìŒì„± ì¸ì‹ ë³€ê²½ ì‹¤íŒ¨', 'error');
        }
      });
    };
    
    const setMode = mode => {
      emit('set_robot_mode', {mode}, res => {
        if (res.success) {
          showNotification(`ëª¨ë“œ ${mode}ìœ¼ë¡œ ë³€ê²½ë¨`);
        } else {
          showNotification('ëª¨ë“œ ë³€ê²½ ì‹¤íŒ¨', 'error');
        }
      });
    };
    
    const setLED = level => {
      emit('send_serial_command', {command: `CMD:LED:${level}`}, res => {
        if (res.success) {
          showNotification(`LED ë ˆë²¨ ${level}ë¡œ ì„¤ì •ë¨`);
        } else {
          showNotification('LED ì„¤ì • ì‹¤íŒ¨', 'error');
        }
      });
    };
    
    // CSV functions
    const takeSnapshot = () => {
      emit('take_snapshot', {}, res => {
        if (res.success) {
          showNotification('ìŠ¤ëƒ…ìƒ· ì €ì¥ë¨');
          if ($('csv-info').style.display !== 'none') getCsvInfo();
        } else {
          showNotification('ì €ì¥ ì‹¤íŒ¨', 'error');
        }
      });
    };
    
    const getCsvInfo = () => {
      emit('get_csv_info', {}, res => {
        const info = $('csv-info');
        if (res.success && res.exists) {
          $('csv-path').textContent = res.file_path;
          $('csv-rows').textContent = res.row_count;
          $('csv-size').textContent = res.file_size;
          info.style.display = 'block';
          showNotification(`CSV: ${res.row_count}í–‰ ì €ì¥ë¨`);
        } else {
          info.style.display = 'none';
          showNotification('CSV íŒŒì¼ ì—†ìŒ', 'warning');
        }
      });
    };
    
    const clearCsv = () => {
      if (!confirm('CSV íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      emit('clear_csv', {}, res => {
        if (res.success) {
          $('csv-info').style.display = 'none';
          showNotification('CSV ì‚­ì œë¨');
        } else {
          showNotification('ì‚­ì œ ì‹¤íŒ¨', 'error');
        }
      });
    };
    
    // Voice logging
    const addVoiceLog = (prefix, text, type) => {
      const log = $('voice-log');
      const entry = document.createElement('div');
      entry.className = `voice-entry voice-${type}`;
      const time = new Date().toLocaleTimeString();
      entry.innerHTML = `<span style="color: #666;">[${time}]</span> ${prefix}: ${text}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      
      if (log.children.length > 30) log.removeChild(log.firstChild);
    };
    
    // Status updates
    const updateControlStatus = active => {
      controlActive = active;
      updateIndicator('control-status', active ? 'on' : 'off');
      $('control-status').innerHTML = `<span class="indicator ${active ? 'on' : 'off'}"></span>ì œì–´: ${active ? 'í™œì„±' : 'ë¹„í™œì„±'}`;
      const btn = $('control-btn');
      btn.textContent = active ? 'ğŸ›‘ ì œì–´ ì¤‘ì§€' : 'â–¶ï¸ ì œì–´ ì‹œì‘';
      btn.className = `btn ${active ? 'btn-red' : 'btn-green'}`;
    };
    
    const updateVoiceStatus = active => {
      voiceActive = active;
      updateIndicator('voice-status', active ? 'on pulse' : 'off');
      $('voice-status').innerHTML = `<span class="indicator ${active ? 'on pulse' : 'off'}"></span>ìŒì„±: ${active ? 'í™œì„±' : 'ë¹„í™œì„±'}`;
      const btn = $('voice-btn');
      btn.textContent = active ? 'ğŸ›‘ ìŒì„± ì¤‘ì§€' : 'ğŸ¤ ìŒì„± ì‹œì‘';
      btn.className = `btn ${active ? 'btn-red' : 'btn-blue'}`;
    };
    
    const updateModeStatus = mode => {
      updateIndicator('mode-status', 'on');
      $('mode-status').innerHTML = `<span class="indicator on"></span>ëª¨ë“œ: ${mode}`;
    };
    
    const updateLEDStatus = level => {
      updateIndicator('led-status', 'on');
      $('led-status').innerHTML = `<span class="indicator on"></span>LED: Level ${level}`;
    };
    
    const updateDataTable = data => {
      const format = v => v !== null ? v : '-';
      $('data-row').innerHTML = `
        <td>${format(data.camera1_tip_x)}</td><td>${format(data.camera1_tip_y)}</td>
        <td>${format(data.camera2_tip_x)}</td><td>${format(data.camera2_tip_y)}</td>
        <td>${format(data.follower_joint_1)}</td><td>${format(data.follower_joint_2)}</td>
        <td>${format(data.follower_joint_3)}</td><td>${format(data.follower_joint_4)}</td>
      `;
    };
    
    // Voice recognition handlers
    const handleVoiceRecognition = data => {
      const icons = {
        listening: 'ğŸ“', wake_word: 'âœ…', command: 'ğŸ¯', 
        executed: 'ğŸ’¡', timeout: 'â°', error: 'âŒ'
      };
      addVoiceLog(icons[data.type] || 'â„¹ï¸', data.text, data.type);
    };
    
    // Initialize
    window.onload = () => {
      socket = io();
      
      // Connection events
      socket.on('connect', () => {
        updateConnection(true);
        showNotification('ì„œë²„ì— ì—°ê²°ë¨');
      });
      
      socket.on('disconnect', () => {
        updateConnection(false);
        showNotification('ì—°ê²° ëŠê¹€', 'warning');
        setTimeout(() => !isConnected && socket.connect(), 3000);
      });
      
      // Status events
      socket.on('status_update', updateDataTable);
      socket.on('control_status', data => updateControlStatus(data.active));
      socket.on('robot_mode', data => updateModeStatus(data.mode));
      socket.on('led_brightness', data => updateLEDStatus(data.level));
      
      // Voice events
      socket.on('voice_status', data => {
        updateVoiceStatus(data.status === 'ready');
        addVoiceLog('ğŸ”§', data.message, data.status === 'error' ? 'error' : 'executed');
      });
      socket.on('voice_recognition', handleVoiceRecognition);
      socket.on('voice_command', data => {
        addVoiceLog('ğŸ’¬', data.command, 'executed');
        showNotification(`ìŒì„± ëª…ë ¹: ${data.command}`);
      });
      
      // System events
      socket.on('system_status', data => {
        if (data.status === 'error') {
          showNotification(`ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${data.message}`, 'error');
        } else if (data.status === 'ready') {
          showNotification('ì‹œìŠ¤í…œ ì¤€ë¹„ë¨');
        }
      });
      
      updateConnection(false);
    };
  </script>
</body>
</html>