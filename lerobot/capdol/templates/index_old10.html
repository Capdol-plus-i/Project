<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¡œë´‡ í•¸ë“œ ì»¨íŠ¸ë¡¤ëŸ¬</title>
  <style>
    body { font-family: Arial, sans-serif; background: #181818; color: #eee; text-align: center; }
    h1 { color: #ffa500; }
    .camera-container { display: flex; justify-content: center; gap: 24px; margin: 24px 0; }
    .camera-box { border: 2px solid #ffa500; border-radius: 16px; padding: 8px; background: #222; }
    .camera-title { margin-bottom: 8px; color: #ffa500; font-weight: bold; }
    .btn { padding: 10px 30px; font-size: 1.1em; margin: 20px; background: #ffa500; border: none; 
           border-radius: 10px; color: #222; font-weight: bold; cursor: pointer; }
    .btn:hover { background: #ffcc66; }
    .btn-group { display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; }
    .btn-green { background: #4caf50; }
    .btn-green:hover { background: #81c784; }
    .btn-red { background: #f44336; }
    .btn-red:hover { background: #e57373; }
    .btn-blue { background: #2196f3; }
    .btn-blue:hover { background: #64b5f6; }
    .btn-purple { background: #9c27b0; }
    .btn-purple:hover { background: #ba68c8; }
    .mode-btn { width: 120px; }
    #status-table { margin: 32px auto; border-collapse: collapse; }
    #status-table th, #status-table td { padding: 8px 14px; border: 1px solid #444; }
    #status-table th { background: #333; color: #ffa500; }
    #status-table td { background: #262626; }
    .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; 
                         margin-right: 8px; background-color: #666; }
    .status-on { background-color: #4caf50; }
    .status-off { background-color: #f44336; }
    .section-title { color: #ffa500; margin-top: 30px; }
    .status-panel { display: flex; justify-content: center; gap: 30px; margin: 20px 0; flex-wrap: wrap; }
    .status-item { background: #222; padding: 10px 20px; border-radius: 10px; border: 1px solid #444; }
    #connection-status { position: fixed; top: 10px; right: 10px; padding: 5px 10px; 
                          border-radius: 5px; font-size: 0.9em; background-color: #444; }
    .connected { background-color: #4caf50 !important; }
    .disconnected { background-color: #f44336 !important; }
    
    /* ìŒì„± ì¸ì‹ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .voice-container { 
      background: #222; 
      border-radius: 16px; 
      padding: 16px;
      margin: 20px auto;
      max-width: 800px;
      border: 2px solid #ffa500;
    }
    #voiceLog {
      height: 180px;
      overflow-y: auto;
      margin: 16px 0;
      padding: 12px;
      background: #262626;
      border-radius: 10px;
      text-align: left;
      font-family: monospace;
      border: 1px solid #444;
    }
    .voice-entry {
      margin: 8px 0;
      padding: 6px;
      border-radius: 5px;
    }
    .voice-listening {
      color: #64b5f6;
    }
    .voice-wake-word {
      color: #4caf50;
      font-weight: bold;
    }
    .voice-command {
      color: #ba68c8;
      font-weight: bold;
    }
    .voice-executed {
      color: #ffa500;
      font-weight: bold;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div id="connection-status" class="disconnected">ì—°ê²° ì¤‘...</div>
  <h1>ë¡œë´‡ í•¸ë“œ ì»¨íŠ¸ë¡¤ëŸ¬</h1>

  <div class="camera-container">
    <div class="camera-box">
      <div class="camera-title">Camera 1 (Control)</div>
      <img id="cam1" src="/video_feed1" width="640" height="480" />
    </div>
    <div class="camera-box">
      <div class="camera-title">Camera 2 (Depth)</div>
      <img id="cam2" src="/video_feed2" width="640" height="480" />
    </div>
  </div>

  <h3 class="section-title">ì¶”ì  ê¸°ë°˜ ì œì–´ (Follower ì•”)</h3>
  <div class="btn-group">
    <button id="controlBtn" class="btn btn-green" onclick="toggleControl()">ë¡œë´‡ ì œì–´ ì‹œì‘</button>
  </div>

  <h3 class="section-title">ìŒì„± ì¸ì‹ ì œì–´</h3>
  <div class="btn-group">
    <button id="voiceBtn" class="btn btn-blue" onclick="toggleVoiceRecognition()">ìŒì„± ì¸ì‹ ì‹œì‘</button>
  </div>

  <div class="voice-container">
    <div id="voiceStatus">
      <span class="status-indicator status-off"></span>ìŒì„± ì¸ì‹: ë¹„í™œì„±í™”
    </div>
    <div id="voiceLog">
      <div class="voice-entry">ìŒì„± ì¸ì‹ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
    <div>
      <p><strong>ì›¨ì´í¬ì›Œë“œ:</strong> í•˜ì´ë´‡, í•˜ì´ëª», ì•„ì´ë´‡, AIë´‡ ë“±</p>
      <p><strong>ëª…ë ¹ì–´:</strong> ì™¼ìª½, ì˜¤ë¥¸ìª½, ìœ„, ì•„ë˜, ì¢…ë£Œ</p>
    </div>
  </div>

  <h3 class="section-title">ë²„íŠ¼ ê¸°ë°˜ ì œì–´ (Leader ì•”)</h3>
  <div class="btn-group">
    <button class="btn btn-blue mode-btn" onclick="setRobotMode(0)">ëª¨ë“œ 0<br>(ìœ„ì¹˜ 110)</button>
    <button class="btn btn-purple mode-btn" onclick="setRobotMode(1)">ëª¨ë“œ 1<br>(ìœ„ì¹˜ 1110)</button>
  </div>

  <div class="status-panel">
    <div class="status-item">
      <span id="controlStatus"><span class="status-indicator status-off"></span>ë¡œë´‡ ì œì–´: ë¹„í™œì„±í™”</span>
    </div>
    <div class="status-item">
      <span id="robotModeStatus"><span class="status-indicator status-off"></span>í˜„ì¬ ëª¨ë“œ: -</span>
    </div>
  </div>

  <table id="status-table">
    <tr>
      <th>Camera 1 X</th><th>Camera 1 Y</th><th>Camera 2 X</th><th>Camera 2 Y</th>
      <th>Follower Joint 1</th><th>Follower Joint 2</th><th>Follower Joint 3</th><th>Follower Joint 4</th>
    </tr>
    <tr id="status-row"><td colspan="8">Loading...</td></tr>
  </table>

  <script>
    let controlActive = false, currentMode = null, socket = null, isConnected = false;
    let voiceRecognitionActive = false;
    
    function updateConnectionStatus(connected) {
      const el = document.getElementById('connection-status');
      el.textContent = connected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ëŠê¹€';
      el.className = connected ? 'connected' : 'disconnected';
      isConnected = connected;
    }
    
    function updateStatusTable(data) {
      document.getElementById('status-row').innerHTML = `
        <td>${data.camera1_tip_x ?? '-'}</td>
        <td>${data.camera1_tip_y ?? '-'}</td>
        <td>${data.camera2_tip_x ?? '-'}</td>
        <td>${data.camera2_tip_y ?? '-'}</td>
        <td>${data.follower_joint_1 ?? '-'}</td>
        <td>${data.follower_joint_2 ?? '-'}</td>
        <td>${data.follower_joint_3 ?? '-'}</td>
        <td>${data.follower_joint_4 ?? '-'}</td>
      `;
    }

    function setRobotMode(mode) {
      if (!isConnected) {
        alert('ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      socket.emit('set_robot_mode', { mode }, (response) => {
        if (!response.success) {
          alert(`ëª¨ë“œ ì„¤ì • ì‹¤íŒ¨: ${response.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
      });
    }

    function updateControlStatus(active) {
      controlActive = active;
      const indicator = document.querySelector('#controlStatus .status-indicator');
      const statusText = document.getElementById('controlStatus');
      const btn = document.getElementById('controlBtn');
      
      indicator.className = `status-indicator status-${active ? 'on' : 'off'}`;
      statusText.innerHTML = `<span class="status-indicator status-${active ? 'on' : 'off'}"></span>
                             ë¡œë´‡ ì œì–´: ${active ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`;
      btn.textContent = active ? 'ë¡œë´‡ ì œì–´ ì¤‘ì§€' : 'ë¡œë´‡ ì œì–´ ì‹œì‘';
      btn.className = `btn ${active ? 'btn-red' : 'btn-green'}`;
    }

    function updateModeStatus(mode) {
      currentMode = mode;
      const modePosition = mode === 0 ? 110 : 1110;
      document.getElementById('robotModeStatus').innerHTML = 
        `<span class="status-indicator status-on"></span>í˜„ì¬ ëª¨ë“œ: ${mode} (ìœ„ì¹˜ ${modePosition})`;
    }

    function toggleControl() {
      if (!isConnected) {
        alert('ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      socket.emit(controlActive ? 'stop_control' : 'start_control', (response) => {
        if (!response.success) {
          alert(`ì œì–´ ${controlActive ? 'ì¤‘ì§€' : 'ì‹œì‘'} ì‹¤íŒ¨`);
        }
      });
    }

    // ìŒì„± ì¸ì‹ ê´€ë ¨ í•¨ìˆ˜
    function toggleVoiceRecognition() {
      if (!isConnected) {
        alert('ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      
      const eventName = voiceRecognitionActive ? 'stop_voice_recognition' : 'start_voice_recognition';
      socket.emit(eventName, (response) => {
        if (!response.success) {
          alert(`ìŒì„± ì¸ì‹ ${voiceRecognitionActive ? 'ì¤‘ì§€' : 'ì‹œì‘'} ì‹¤íŒ¨: ${response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        } else {
          updateVoiceStatus(!voiceRecognitionActive);
          if (!voiceRecognitionActive) {
            addVoiceLog('ì‹œìŠ¤í…œ', 'ìŒì„± ì¸ì‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì›¨ì´í¬ì›Œë“œë¥¼ ë§í•´ì£¼ì„¸ìš”.', 'executed');
          }
        }
      });
    }

    function updateVoiceStatus(active) {
      voiceRecognitionActive = active;
      const indicator = document.querySelector('#voiceStatus .status-indicator');
      const statusText = document.getElementById('voiceStatus');
      const btn = document.getElementById('voiceBtn');
      
      indicator.className = `status-indicator status-${active ? 'on' : 'off'} ${active ? 'pulse' : ''}`;
      statusText.innerHTML = `<span class="status-indicator status-${active ? 'on' : 'off'} ${active ? 'pulse' : ''}"></span>
                             ìŒì„± ì¸ì‹: ${active ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`;
      btn.textContent = active ? 'ìŒì„± ì¸ì‹ ì¤‘ì§€' : 'ìŒì„± ì¸ì‹ ì‹œì‘';
      btn.className = `btn ${active ? 'btn-red' : 'btn-blue'}`;
    }

    function addVoiceLog(prefix, text, type) {
      const logElement = document.getElementById('voiceLog');
      const entry = document.createElement('div');
      entry.className = `voice-entry voice-${type}`;
      entry.textContent = `${prefix}: ${text}`;
      logElement.appendChild(entry);
      logElement.scrollTop = logElement.scrollHeight;  // ìë™ ìŠ¤í¬ë¡¤
    }

    function handleVoiceRecognition(data) {
      const text = data.text;
      const type = data.type;
      let prefix = '';
      
      switch (type) {
        case 'listening':
          prefix = 'ğŸ“ ì¸ì‹ë¨';
          break;
        case 'wake_word':
          prefix = 'âœ… ì›¨ì´í¬ì›Œë“œ';
          break;
        case 'command':
          prefix = 'ğŸ¯ ëª…ë ¹';
          break;
        case 'executed':
          prefix = 'ğŸ’¡ ì‹¤í–‰';
          break;
        default:
          prefix = 'ì •ë³´';
      }
      
      addVoiceLog(prefix, text, type);
    }

    window.onload = function() {
      socket = io();
      socket.on('connect', () => {
        updateConnectionStatus(true);
      });
      socket.on('disconnect', () => {
        updateConnectionStatus(false);
        setTimeout(() => { if (!isConnected) socket.connect(); }, 3000);
      });
      socket.on('status_update', updateStatusTable);
      socket.on('control_status', data => updateControlStatus(data.active));
      socket.on('robot_mode', data => updateModeStatus(data.mode));
      socket.on('system_status', data => {
        if (data.status === 'error') {
          alert(`ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
      });

      // ìŒì„± ì¸ì‹ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      socket.on('voice_status', data => {
        updateVoiceStatus(data.status === 'ready');
        addVoiceLog('ìƒíƒœ', data.message, data.status === 'error' ? 'error' : 'executed');
      });
      
      socket.on('voice_recognition', handleVoiceRecognition);
      
      socket.on('voice_command', data => {
        addVoiceLog('ğŸ’¬ ëª…ë ¹ ìˆ˜ì‹ ', data.command, 'executed');
      });
    };
  </script>
</body>
</html>